<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
        namespace="com.ssafy.msg.article.model.mapper.ArticleMapper">

    <insert id="createArticle" parameterType="ArticleCreateDto" useGeneratedKeys="true" keyProperty="id">
        insert into articles
            (user_id, content, create_time, flag_private, modify_time, room_id)
        values ( #{userId}, #{content}, now(), #{flagPrivate}, now(), #{roomId});

    </insert>

    <insert id="insertArticleImage" parameterType="ArticleImageDto">
        insert into article_images
            (article_id, url, uuid, flag_mission)
        values (#{articleId}, #{url}, #{uuid}, #{flagMission})

    </insert>

    <select id="getArticles" parameterType="int" resultType="ArticleWithUrlDto" >
        select a.id as article_id, a.user_id, a.create_time, a.flag_private, a.modify_time, a.room_id, ai.url
        from articles a
        left join (
            select article_id, MIN(id) as min_id
            from article_images
            group by article_id
        ) as sub_ai on a.id = sub_ai.article_id
        left join article_images ai on sub_ai.min_id = ai.id
        where a.user_id = #{userId};

    </select>

    <select id="getArticleDetail" parameterType="int" resultType="ArticleDetailDto">
        select a.id as article_id, a.user_id, a.content, a.create_time, a.flag_private, a.modify_time, a.room_id
        from articles a
        where a.id = #{articleId};
    </select>

    <select id="getArticleImages" parameterType="int" resultType="ArticleImageDto">
        select *
        from article_images
        where article_id = #{articleId}
        order by id;

    </select>

    <select id="getFeedArticleList" parameterType="int" resultType="ArticleDetailDto">
        select *
        from articles a
        left join article_images ai on a.id = ai.article_id
        where a.user_id in (
            select f.to_user_id
            from follows f
            where f.from_user_id = #{userId}
            )
        order by a.create_time desc;

    </select>

</mapper>